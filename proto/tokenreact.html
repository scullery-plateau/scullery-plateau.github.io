<html>
    <head>
        <title>Scullery Plateau: Tokenizer</title>

        <!-- external styles -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        />
        <link
            href="https://fonts.googleapis.com/css?family=Caudex"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css?family=Modern+Antiqua"
            rel="stylesheet"
        />

        <!-- project styles -->
        <link rel="stylesheet" href="../../style/rpg.css" />
        <link rel="stylesheet" href="../../style/font.css" />
        <link rel="stylesheet" href="../../style/menu.css" />

        <script type="text/javascript" src="scripts/menues.js"></script>
        <!--<script type="text/javascript" src="scripts/popup.js"></script>-->
        <script type="text/javascript" src="scripts/test-image.js"></script>

        <script
            src="https://unpkg.com/react@18/umd/react.development.js"
            crossorigin
        ></script>
        <script
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
            crossorigin
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <script type="text/babel">
            (function(){
                const initTokenState = function() {
                    return {
                        baseScale: 100,
                        frameColor: 'red',
                        id: "bergrum.png",
                        scale: 1,
                        sideCount: 2,
                        url: getTestImage(),
                        xOffset: 0,
                        yOffset: 0
                    }
                }
                const getImageOrigin = function (data, offset) {
                    let i = 1 - data.scale;
                    i = i / 2;
                    i = i * data.baseScale;
                    return i + offset;
                };
                const getFrameRadius = function(data) {
                    const i = data.baseScale / 2;
                    return i - 1;
                };
                const drawShape = function (s) {
                    const n = s.numberOfSides;
                    if (n > 2 && n < 50) {
                        const a = (Math.PI * 2) / n;
                        const first = a / 2;
                        const points = Array(n)
                        .fill(0)
                        .map((e, i) => {
                            let ai = first + a * i;
                            return [
                            s.cx + s.r * Math.sin(ai),
                            s.cy + s.r * Math.cos(ai),
                            ].join(',');
                        })
                        .join(' ');
                        return <>
                            <polygon points={points} fill={s.bgColor}/>
                            <polygon points={points} fill={`url(#${s.patternId})`} stroke={s.frameColor} strokeWidth="1"/>
                        </>;
                    } else {
                        return <>
                            <circle cx={s.cx} cy={s.cy} r={s.r} fill={s.bgColor}/>
                            <circle cx={s.cx} cy={s.cy} r={s.r} fill={`url(#${s.patternId})`} stroke={s.frameColor} strokeWidth="1"/>
                        </>;
                    }
                };
                const Token = function(props) {
                    const patternId = "myImage";
                    const shape = drawShape({
                        patternId: patternId,
                        numberOfSides: props.token.sideCount,
                        cx: props.token.baseScale / 2,
                        cy: props.token.baseScale / 2,
                        r: getFrameRadius(props.token),
                        bgColor: props.token.backgroundColor,
                        frameColor: props.token.frameColor,
                    });
                    return <svg width="20em" height="20em" viewBox={`0 0 ${ props.token.baseScale } ${ props.token.baseScale }`}>
                        <defs>
                            <pattern id={ patternId } x="0" y="0" width="100%" height="100%">
                                <image 
                                    x="0" 
                                    y="0" 
                                    width={props.token.baseScale}
                                    height={props.token.baseScale}
                                    href={props.token.url} 
                                    transform={`translate(${getImageOrigin(props.token,props.token.xOffset)},${getImageOrigin(props.token,props.token.yOffset)}) scale(${props.token.scale})`}/>
                            </pattern>
                        </defs>
                        { shape }
                    </svg>;
                }
                const TokenFrame = class extends React.Component {
                    constructor(props) {
                        super(props);
                        this.state = initTokenState();
                    }
                    render() {
                        return <div className="rpg-box m-3 d-flex">
                            <div className="d-flex flex-column w-25 controls">
                                <div className="form-group">
                                    <label htmlFor="xOffset">X-Offset:</label>
                                    <input
                                        type="number"
                                        value={ this.state.xOffset }
                                        className="form-control"
                                        id="xOffset"
                                        onChange={(e) => { this.setState({ xOffset: parseInt(e.target.value) }); }}
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="yOffset">Y-Offset:</label>
                                    <input
                                        type="number"
                                        value={ this.state.yOffset }
                                        className="form-control"
                                        id="yOffset"
                                        onChange={(e) => { this.setState({ yOffset: parseInt(e.target.value) }); }}
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="scale">Scale:</label>
                                    <input
                                        type="number"
                                        min="0"
                                        value={ this.state.scale }
                                        step="0.01"
                                        className="form-control"
                                        id="scale"
                                        onChange={(e) => { this.setState({ scale: parseFloat(e.target.value) }); }}
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="sideCount">Side Count:</label>
                                    <input
                                        type="number"
                                        min="2"
                                        max="50"
                                        value={ this.state.sideCount }
                                        className="form-control"
                                        id="sideCount"
                                        onChange={(e) => { this.setState({ sideCount: parseInt(e.target.value) }); }}
                                    />
                                </div>
                                <button className="btn btn-light">Frame Color</button>
                            </div>
                            <Token token={ this.state }/>
                        </div>;
                    }
                }
                ReactDOM.createRoot(document.getElementById('tokenFrame')).render(<TokenFrame/>);
            })();
        </script>
    </head>
    <body class="bg-dark text-light">
        <div class="navbar justify-content-start">
            <div class="mr-3">
              <ul class="navbar-nav">
                <li class="rpg-box pl-3 pr-3 nav-item active drowpdown">
                  <a
                    href="#"
                    class="text-light nav-link dropdown-toggle"
                    onclick="toggleMenu(event,this)"
                  ></a>
                  <ul class="dropdown-menu rpg-box"></ul>
                </li>
              </ul>
            </div>
            <a href="index.html" class="navbar-brand text-light">Scullery Plateau:</a>
            <span class="navbar-brand">Tokenizer</span>
        </div>
        <div id="tokenFrame"></div>
    </body>
</html>